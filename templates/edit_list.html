{% extends "base.html" %}

{% block title %}Edit: {{ list.title }} - Jukeboxd{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex justify-between items-center">
        <h1 id="list-title-display" class="text-2xl font-bold">{{ list.title }}</h1>
        <div class="flex gap-3">
            <button onclick="duplicateList()" class="text-muted hover:text-white text-sm">Duplicate</button>
            <a href="{{ url_for('view_list', list_id=list.id) }}" class="btn-secondary text-xs">View List</a>
        </div>
    </div>
</div>

<!-- List Settings -->
<div class="card p-4 mb-6">
    <div class="flex justify-between items-center mb-3">
        <h2 class="font-semibold">Settings</h2>
        <span id="settings-status" class="text-xs text-accent hidden">Saved!</span>
    </div>

    <div class="grid gap-3">
        <div>
            <label class="block text-xs text-muted mb-1">Title</label>
            <input type="text" id="settings-title" value="{{ list.title }}" class="input-field">
        </div>

        <div>
            <label class="block text-xs text-muted mb-1">Description</label>
            <textarea id="settings-description" rows="2" class="input-field">{{ list.description or '' }}</textarea>
        </div>

        <div class="flex gap-5">
            <label class="flex items-center gap-2 cursor-pointer text-sm">
                <input type="checkbox" id="settings-public" {% if list.is_public %}checked{% endif %}
                       class="w-4 h-4 accent-accent">
                <span>Public</span>
            </label>

            <label class="flex items-center gap-2 cursor-pointer text-sm">
                <input type="checkbox" id="settings-ranked" {% if list.is_ranked %}checked{% endif %}
                       class="w-4 h-4 accent-accent">
                <span>Ranked</span>
            </label>
        </div>

        <div class="flex justify-between items-center pt-2">
            <button onclick="saveSettings()" class="btn-primary text-xs">Save Settings</button>
            <button onclick="deleteList()" class="text-danger hover:text-red-400 text-xs">Delete List</button>
        </div>
    </div>
</div>

<!-- Search Section -->
<div class="card p-4 mb-6">
    <h2 class="font-semibold mb-3">Add Songs</h2>

    <div class="relative mb-3">
        <input type="text" id="search-input" class="input-field" placeholder="Search for a song or artist...">
        <div id="search-results" class="absolute z-10 w-full bg-elevated border border-border rounded mt-1 hidden max-h-72 overflow-y-auto"></div>
    </div>

    <button type="button" id="toggle-bulk" class="text-xs text-muted hover:text-accent">+ Bulk add multiple songs</button>

    <div id="bulk-section" class="hidden mt-3">
        <textarea id="bulk-input" rows="5" class="input-field mb-2" placeholder="Paste song names here, one per line"></textarea>
        <div class="flex gap-2">
            <button type="button" id="bulk-add-btn" class="btn-primary text-xs">Search & Add All</button>
            <button type="button" id="bulk-cancel" class="text-muted hover:text-white text-xs">Cancel</button>
        </div>
        <div id="bulk-status" class="mt-2 text-xs text-muted hidden"></div>
    </div>
</div>

<!-- Swap Modal -->
<div id="swap-modal" class="fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center">
    <div class="bg-surface border border-border rounded-lg p-5 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold">Swap Song</h3>
            <button onclick="closeSwapModal()" class="text-muted hover:text-white text-xl">&times;</button>
        </div>
        <input type="text" id="swap-search-input" class="input-field mb-3" placeholder="Search for the correct version...">
        <div id="swap-search-results" class="max-h-60 overflow-y-auto"></div>
    </div>
</div>

<!-- Current Items -->
<div class="card p-4">
    <div class="flex justify-between items-center mb-3">
        <h2 class="font-semibold">
            Songs <span class="text-muted font-normal">(<span id="item-count">{{ items|length }}</span>)</span>
        </h2>
        <span class="text-xs text-muted md:hidden">Hold to drag</span>
    </div>

    <div id="items-container">
        {% if items %}
            {% for item in items %}
            <div class="flex items-center gap-3 py-2 border-b border-border item-row" data-id="{{ item.id }}">
                <div class="drag-handle text-muted hover:text-white cursor-grab active:cursor-grabbing">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M7 2a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM7 8a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM7 14a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM13 2a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM13 8a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM13 14a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/>
                    </svg>
                </div>

                {% if list.is_ranked %}
                <div class="w-6 text-center text-sm font-medium text-accent position-display">{{ item.position }}</div>
                {% endif %}

                <img src="{{ item.album_art_url or '' }}" alt="" class="w-10 h-10 rounded object-cover bg-elevated">

                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium truncate">{{ item.track_name }}</p>
                    <p class="text-xs text-muted truncate">{{ item.artist_name }}</p>
                </div>

                <button onclick="swapItem('{{ item.id }}', '{{ item.track_name }}')" class="text-muted hover:text-accent text-xs whitespace-nowrap">Swap</button>
                <button onclick="removeItem('{{ item.id }}')" class="text-muted hover:text-danger text-xs whitespace-nowrap">✕</button>
            </div>
            {% endfor %}
        {% else %}
            <p id="empty-message" class="text-muted text-center py-6 text-sm">No songs yet. Search above to add some!</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
const listId = "{{ list.id }}";
const isRanked = {{ 'true' if list.is_ranked else 'false' }};
let searchTimeout;

const searchInput = document.getElementById('search-input');
const searchResults = document.getElementById('search-results');
const itemsContainer = document.getElementById('items-container');
const itemCount = document.getElementById('item-count');

const toggleBulk = document.getElementById('toggle-bulk');
const bulkSection = document.getElementById('bulk-section');
const bulkInput = document.getElementById('bulk-input');
const bulkAddBtn = document.getElementById('bulk-add-btn');
const bulkCancel = document.getElementById('bulk-cancel');
const bulkStatus = document.getElementById('bulk-status');

toggleBulk.addEventListener('click', () => {
    bulkSection.classList.toggle('hidden');
    toggleBulk.textContent = bulkSection.classList.contains('hidden') ? '+ Bulk add multiple songs' : '− Hide bulk add';
});

bulkCancel.addEventListener('click', () => {
    bulkSection.classList.add('hidden');
    toggleBulk.textContent = '+ Bulk add multiple songs';
    bulkInput.value = '';
    bulkStatus.classList.add('hidden');
});

const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

bulkAddBtn.addEventListener('click', async () => {
    const lines = bulkInput.value.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    if (lines.length === 0) {
        bulkStatus.classList.remove('hidden');
        bulkStatus.textContent = 'Please paste some song names first';
        return;
    }

    bulkAddBtn.disabled = true;
    bulkAddBtn.textContent = 'Adding...';
    bulkStatus.classList.remove('hidden');

    let added = 0;
    let failed = [];

    for (let i = 0; i < lines.length; i++) {
        const query = lines[i];
        bulkStatus.textContent = `Searching ${i + 1}/${lines.length}: "${query}"...`;

        try {
            const searchRes = await fetch(`/api/spotify/search?q=${encodeURIComponent(query)}`);
            if (!searchRes.ok) { failed.push(query); await delay(200); continue; }

            const data = await searchRes.json();
            if (data.tracks && data.tracks.length > 0) {
                const track = data.tracks[0];
                const addRes = await fetch(`/api/list/${listId}/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        track_id: track.id, track_name: track.name, artist_name: track.artist,
                        album_name: track.album, album_art_url: track.album_art
                    })
                });
                const addData = await addRes.json();
                if (addData.success && addData.item) { addItemToDOM(addData.item); added++; }
                else { failed.push(query); }
            } else { failed.push(query); }
            await delay(150);
        } catch (e) { failed.push(query); }
    }

    bulkAddBtn.disabled = false;
    bulkAddBtn.textContent = 'Search & Add All';
    let statusMsg = `Added ${added} song${added !== 1 ? 's' : ''}.`;
    if (failed.length > 0) statusMsg += ` Failed: ${failed.slice(0, 3).join(', ')}${failed.length > 3 ? '...' : ''}`;
    bulkStatus.textContent = statusMsg;
    if (added > 0) bulkInput.value = '';
});

// Detect if device is touch-only (mobile)
const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

// Enable drag-and-drop on both desktop and mobile
// On mobile, use delay (long-press) to initiate drag so scrolling still works
let sortable = new Sortable(itemsContainer, {
    animation: 150,
    handle: '.drag-handle',
    ghostClass: 'opacity-50',
    // On touch devices, require 300ms hold before drag starts (allows scrolling)
    delay: isTouchDevice ? 300 : 0,
    delayOnTouchOnly: true,
    touchStartThreshold: 5,
    onEnd: function(evt) {
        const rows = itemsContainer.querySelectorAll('.item-row');
        const newOrder = [];
        rows.forEach((row, index) => {
            const itemId = row.dataset.id;
            const newPosition = index + 1;
            newOrder.push({ item_id: itemId, position: newPosition });
            const posDisplay = row.querySelector('.position-display');
            if (posDisplay) posDisplay.textContent = newPosition;
        });
        fetch(`/api/list/${listId}/reorder-all`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order: newOrder })
        });
    }
});

searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();
    if (query.length < 2) { searchResults.classList.add('hidden'); return; }

    searchTimeout = setTimeout(() => {
        fetch(`/api/spotify/search?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                if (data.tracks && data.tracks.length > 0) {
                    searchResults.innerHTML = data.tracks.map(track => `
                        <div class="flex items-center gap-3 p-3 hover:bg-surface cursor-pointer" onclick="addTrack(${JSON.stringify(track).replace(/"/g, '&quot;')})">
                            <img src="${track.album_art || ''}" alt="" class="w-9 h-9 rounded object-cover bg-elevated">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium truncate">${track.name}</p>
                                <p class="text-xs text-muted truncate">${track.artist}</p>
                            </div>
                            <span class="text-accent text-xs font-medium">+ Add</span>
                        </div>
                    `).join('');
                    searchResults.classList.remove('hidden');
                } else {
                    searchResults.innerHTML = '<p class="p-3 text-muted text-sm">No results found</p>';
                    searchResults.classList.remove('hidden');
                }
            });
    }, 300);
});

document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.add('hidden');
    }
});

function addItemToDOM(item) {
    const emptyMsg = document.getElementById('empty-message');
    if (emptyMsg) emptyMsg.remove();

    const html = `
        <div class="flex items-center gap-3 py-2 border-b border-border item-row" data-id="${item.id}">
            <div class="drag-handle text-muted hover:text-white cursor-grab active:cursor-grabbing">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M7 2a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM7 8a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM7 14a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM13 2a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM13 8a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM13 14a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/>
                </svg>
            </div>
            ${isRanked ? `<div class="w-6 text-center text-sm font-medium text-accent position-display">${item.position}</div>` : ''}
            <img src="${item.album_art_url || ''}" alt="" class="w-10 h-10 rounded object-cover bg-elevated">
            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium truncate">${item.track_name}</p>
                <p class="text-xs text-muted truncate">${item.artist_name}</p>
            </div>
            <button onclick="swapItem('${item.id}', '${item.track_name.replace(/'/g, "\\'")}')" class="text-muted hover:text-accent text-xs whitespace-nowrap">Swap</button>
            <button onclick="removeItem('${item.id}')" class="text-muted hover:text-danger text-xs whitespace-nowrap">✕</button>
        </div>
    `;
    itemsContainer.insertAdjacentHTML('beforeend', html);
    updateItemCount(1);
}

function addTrack(track) {
    fetch(`/api/list/${listId}/add`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            track_id: track.id, track_name: track.name, artist_name: track.artist,
            album_name: track.album, album_art_url: track.album_art
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success && data.item) {
            addItemToDOM(data.item);
            searchInput.value = '';
            searchResults.classList.add('hidden');
        }
    });
}

function removeItem(itemId) {
    if (!confirm('Remove this song?')) return;
    fetch(`/api/list/${listId}/remove/${itemId}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.querySelector(`.item-row[data-id="${itemId}"]`).remove();
                updateItemCount(-1);
            }
        });
}

function updateItemCount(delta) {
    const current = parseInt(itemCount.textContent) || 0;
    itemCount.textContent = current + delta;
}

const swapModal = document.getElementById('swap-modal');
const swapSearchInput = document.getElementById('swap-search-input');
const swapSearchResults = document.getElementById('swap-search-results');
let currentSwapItemId = null;
let swapSearchTimeout;

function swapItem(itemId, trackName) {
    currentSwapItemId = itemId;
    swapSearchInput.value = trackName;
    swapSearchResults.innerHTML = '';
    swapModal.classList.remove('hidden');
    swapSearchInput.focus();
    doSwapSearch(trackName);
}

function closeSwapModal() {
    swapModal.classList.add('hidden');
    currentSwapItemId = null;
    swapSearchInput.value = '';
    swapSearchResults.innerHTML = '';
}

function doSwapSearch(query) {
    if (query.length < 2) { swapSearchResults.innerHTML = ''; return; }

    fetch(`/api/spotify/search?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            if (data.tracks && data.tracks.length > 0) {
                swapSearchResults.innerHTML = data.tracks.map(track => `
                    <div class="flex items-center gap-3 p-3 hover:bg-elevated cursor-pointer border-b border-border" onclick="selectSwapTrack(${JSON.stringify(track).replace(/"/g, '&quot;')})">
                        <img src="${track.album_art || ''}" alt="" class="w-9 h-9 rounded object-cover bg-elevated">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium truncate">${track.name}</p>
                            <p class="text-xs text-muted truncate">${track.artist}</p>
                            <p class="text-xs text-muted/60 truncate">${track.album}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                swapSearchResults.innerHTML = '<p class="p-3 text-muted text-sm">No results found</p>';
            }
        });
}

swapSearchInput.addEventListener('input', function() {
    clearTimeout(swapSearchTimeout);
    swapSearchTimeout = setTimeout(() => doSwapSearch(this.value.trim()), 300);
});

function selectSwapTrack(track) {
    if (!currentSwapItemId) return;
    swapSearchResults.innerHTML = '<p class="p-3 text-muted text-sm">Saving...</p>';

    fetch(`/api/list/${listId}/update/${currentSwapItemId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            track_id: track.id, track_name: track.name, artist_name: track.artist,
            album_name: track.album, album_art_url: track.album_art
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const row = document.querySelector(`.item-row[data-id="${currentSwapItemId}"]`);
            if (row) {
                const img = row.querySelector('img');
                const textDiv = row.querySelector('.flex-1.min-w-0');
                if (img) img.src = track.album_art || '';
                if (textDiv) {
                    const titleEl = textDiv.querySelector('p:first-child');
                    const artistEl = textDiv.querySelector('p:last-child');
                    if (titleEl) titleEl.textContent = track.name;
                    if (artistEl) artistEl.textContent = track.artist;
                }
            }
            closeSwapModal();
        } else {
            alert('Failed to save. Please try again.');
            closeSwapModal();
        }
    })
    .catch(err => {
        alert('Error saving swap. Please try again.');
        closeSwapModal();
    });
}

swapModal.addEventListener('click', function(e) {
    if (e.target === swapModal) closeSwapModal();
});

function saveSettings() {
    const title = document.getElementById('settings-title').value.trim();
    const description = document.getElementById('settings-description').value.trim();
    const isPublic = document.getElementById('settings-public').checked;
    const newIsRanked = document.getElementById('settings-ranked').checked;

    if (!title) { alert('Title is required'); return; }

    fetch(`/api/list/${listId}/settings`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, description, is_public: isPublic, is_ranked: newIsRanked })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById('list-title-display').textContent = title;
            document.title = `Edit: ${title} - Jukeboxd`;
            const status = document.getElementById('settings-status');
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 2000);
            if (newIsRanked !== isRanked) location.reload();
        }
    });
}

function duplicateList() {
    if (!confirm('Create a copy of this list?')) return;
    fetch(`/api/list/${listId}/duplicate`, { method: 'POST', headers: { 'Content-Type': 'application/json' } })
    .then(res => res.json())
    .then(data => {
        if (data.success && data.new_list_id) window.location.href = `/list/${data.new_list_id}/edit`;
        else alert('Failed to duplicate list');
    });
}

function deleteList() {
    if (!confirm('Are you sure you want to delete this list? This cannot be undone.')) return;
    fetch(`/api/list/${listId}/delete`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } })
    .then(res => res.json())
    .then(data => {
        if (data.success) window.location.href = '/dashboard';
        else alert('Failed to delete list');
    });
}
</script>
{% endblock %}
