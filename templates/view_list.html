{% extends "base.html" %}

{% block title %}{{ list.title }} - Jukeboxd{% endblock %}

{% block content %}
<div class="mb-6">
    <!-- Mobile: Buttons on top row -->
    <div class="flex flex-wrap gap-2 mb-3 md:hidden">
        <!-- Like button -->
        {% if not is_owner %}
        <button id="like-btn-mobile" onclick="toggleLike()" class="like-btn flex items-center gap-1 text-sm px-3 py-1.5 rounded-lg border border-border hover:border-accent transition">
            <span class="like-icon text-lg">♡</span>
            <span class="like-count">0</span>
        </button>
        {% else %}
        <span class="text-muted text-sm flex items-center gap-1">
            <span class="text-accent">♥</span> <span class="like-count">0</span> likes
        </span>
        {% endif %}
        {% if session.user %}
        <button onclick="duplicateList()" class="btn-secondary text-xs">Copy</button>
        <button onclick="openExportSpotifyModal()" class="btn-spotify text-xs">
            <svg class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
            Export
        </button>
        {% endif %}
        {% if is_owner %}
        <a href="{{ url_for('edit_list', list_id=list.id) }}" class="btn-primary text-xs">Edit List</a>
        {% endif %}
    </div>

    <!-- Desktop: Standard layout with buttons on right -->
    <div class="flex justify-between items-start gap-4">
        <div class="min-w-0 flex-1">
            <h1 class="text-xl md:text-2xl font-bold">{{ list.title }}</h1>
            <p class="text-sm text-muted mt-1">
                by <a href="{{ url_for('user_profile', username=list.profiles.username) }}" class="text-accent hover:underline">{{ list.profiles.username if list.profiles else 'Unknown' }}</a>
                <span class="mx-1">·</span>
                {{ items|length }} song{{ 's' if items|length != 1 else '' }}
                {% if list.is_ranked %}<span class="mx-1">·</span> Ranked{% endif %}
                <span class="mx-1">·</span>
                {{ list.created_at[:10] }}
            </p>
        </div>
        <!-- Desktop buttons -->
        <div class="hidden md:flex gap-2 flex-shrink-0 items-center">
            <!-- Like button -->
            {% if not is_owner %}
            <button id="like-btn" onclick="toggleLike()" class="like-btn flex items-center gap-1 text-sm px-3 py-1.5 rounded-lg border border-border hover:border-accent transition">
                <span class="like-icon text-lg">♡</span>
                <span class="like-count">0</span>
            </button>
            {% else %}
            <span id="like-count-display" class="text-muted text-sm flex items-center gap-1">
                <span class="text-accent">♥</span> <span class="like-count">0</span> likes
            </span>
            {% endif %}
            {% if session.user %}
            <button onclick="duplicateList()" class="btn-secondary text-xs">Copy</button>
            <button onclick="openExportSpotifyModal()" class="btn-spotify text-xs">
                <svg class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
                Export
            </button>
            {% endif %}
            {% if is_owner %}
            <a href="{{ url_for('edit_list', list_id=list.id) }}" class="btn-primary text-xs">Edit List</a>
            {% endif %}
        </div>
    </div>

    {% if list.description %}
        <p class="text-muted text-sm mt-3 max-w-2xl">{{ list.description }}</p>
    {% endif %}
</div>

{% if items %}
    <div id="album-grid" class="album-grid">
        {% for item in items %}
        <div class="album-tile group" data-id="{{ item.id }}"
             data-track-id="{{ item.spotify_track_id }}"
             data-track-name="{{ item.track_name }}"
             data-artist-name="{{ item.artist_name }}"
             data-album-name="{{ item.album_name }}"
             data-album-art="{{ item.album_art_url }}">
            {% if item.album_art_url %}
                <img src="{{ item.album_art_url }}" alt="{{ item.album_name }}" draggable="false">
            {% else %}
                <div class="w-full h-full bg-elevated flex items-center justify-center">
                    <span class="text-3xl text-muted">♪</span>
                </div>
            {% endif %}

            {% if list.is_ranked %}
                <div class="rank-badge">{{ item.position }}</div>
            {% endif %}

            <!-- Three-dot menu button -->
            {% if session.user %}
            <button class="tile-menu-btn" onclick="event.stopPropagation(); openTileMenu(this, '{{ item.id }}')">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <circle cx="10" cy="4" r="2"/>
                    <circle cx="10" cy="10" r="2"/>
                    <circle cx="10" cy="16" r="2"/>
                </svg>
            </button>
            {% endif %}

            <!-- Hover overlay (desktop only) -->
            <div class="absolute inset-0 bg-black/80 opacity-0 md:group-hover:opacity-100 transition-opacity hidden md:flex flex-col justify-end p-3 hover-overlay"
                 data-type="song"
                 data-name="{{ item.track_name }}"
                 data-artist="{{ item.artist_name }}"
                 data-album="{{ item.album_name }}"
                 data-art="{{ item.album_art_url }}">
                <!-- Hover rating stars -->
                <div class="hover-stars flex gap-0.5 mb-2" onmouseleave="resetHoverStars(this)" onclick="event.stopPropagation()">
                    {% for i in range(5) %}
                    <svg class="w-5 h-5 cursor-pointer hover-star" viewBox="0 0 24 24" data-index="{{ i }}"
                         onmouseenter="previewHoverStar(this, {{ i + 1 }})"
                         onclick="event.stopPropagation(); setHoverRating(this, {{ i + 1 }})">
                        <path class="star-bg-path" fill="#3a3f47" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        <path class="star-fill-path" fill="#22d3ee" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" style="opacity: 0;"/>
                    </svg>
                    {% endfor %}
                    <span class="hover-rating-text text-xs text-muted ml-1"></span>
                </div>
                <p class="text-white font-medium text-sm truncate pointer-events-none">{{ item.track_name }}</p>
                <p class="text-muted text-xs truncate pointer-events-none">{{ item.artist_name }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="card text-center py-12">
        <p class="text-muted">This list is empty</p>
        {% if is_owner %}
            <a href="{{ url_for('edit_list', list_id=list.id) }}" class="btn-primary mt-4 inline-block">Add songs</a>
        {% endif %}
    </div>
{% endif %}

<!-- Tile Menu Dropdown -->
<div id="tile-menu" class="tile-menu hidden">
    <button onclick="openAddToListModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
        </svg>
        Add to list
    </button>
    <button onclick="openRatingModal('album')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
        Rate album
    </button>
    <button onclick="openRatingModal('song')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
        Rate song
    </button>
</div>

<!-- Add to List Modal -->
<div id="add-to-list-modal" class="fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center">
    <div class="bg-surface border border-border rounded-lg p-6 w-full max-w-md mx-4 max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-semibold text-lg">Add to List</h3>
            <button onclick="closeAddToListModal()" class="text-muted hover:text-white text-2xl">&times;</button>
        </div>
        <div id="user-lists-container" class="flex-1 overflow-y-auto space-y-2">
            <p class="text-muted text-sm">Loading your lists...</p>
        </div>
        <div class="mt-4 pt-4 border-t border-border">
            <button onclick="createNewListWithTrack()" class="btn-primary w-full text-sm">+ Create new list with this song</button>
        </div>
    </div>
</div>

<!-- Rating Modal -->
<div id="rating-modal" class="fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center">
    <div class="bg-surface border border-border rounded-lg p-6 w-full max-w-sm mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 id="rating-modal-title" class="font-semibold text-lg">Rate Album</h3>
            <button onclick="closeRatingModal()" class="text-muted hover:text-white text-2xl">&times;</button>
        </div>
        <div class="flex items-center gap-3 mb-6">
            <img id="rating-album-art" src="" alt="" class="w-16 h-16 rounded object-cover bg-elevated">
            <div class="flex-1 min-w-0">
                <p id="rating-item-name" class="font-medium truncate"></p>
                <p id="rating-artist-name" class="text-sm text-muted truncate"></p>
            </div>
        </div>
        <div class="flex flex-col items-center">
            <div id="star-rating" class="star-rating-container" onmouseleave="resetStarPreview()">
                <!-- 5 stars, each divided into 4 quarters -->
                {% for i in range(5) %}
                <div class="star-wrapper">
                    <svg class="star-bg" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    <svg class="star-fill" viewBox="0 0 24 24" style="clip-path: inset(0 100% 0 0);">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    <div class="star-quarters">
                        <div class="quarter q1" data-value="{{ i + 0.25 }}" onmouseenter="previewRating({{ i + 0.25 }})" onclick="setRating({{ i + 0.25 }})"></div>
                        <div class="quarter q2" data-value="{{ i + 0.5 }}" onmouseenter="previewRating({{ i + 0.5 }})" onclick="setRating({{ i + 0.5 }})"></div>
                        <div class="quarter q3" data-value="{{ i + 0.75 }}" onmouseenter="previewRating({{ i + 0.75 }})" onclick="setRating({{ i + 0.75 }})"></div>
                        <div class="quarter q4" data-value="{{ i + 1 }}" onmouseenter="previewRating({{ i + 1 }})" onclick="setRating({{ i + 1 }})"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <p id="rating-display" class="text-muted text-sm mt-3">Click to rate</p>
        </div>
        <div class="mt-6 flex gap-3">
            <button onclick="clearRating()" class="btn-secondary flex-1 text-sm">Clear</button>
            <button onclick="saveRating()" class="btn-primary flex-1 text-sm">Save</button>
        </div>
    </div>
</div>

<!-- Song/Album Detail Modal -->
<div id="detail-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center">
    <div class="bg-surface border border-border rounded-lg w-full max-w-2xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-6 border-b border-border">
            <div class="flex justify-between items-start">
                <div class="flex gap-4">
                    <img id="detail-art" src="" alt="" class="w-24 h-24 rounded-lg object-cover bg-elevated flex-shrink-0">
                    <div class="flex-1 min-w-0">
                        <p id="detail-type" class="text-xs text-muted uppercase tracking-wider mb-1"></p>
                        <h2 id="detail-name" class="text-xl font-bold text-white truncate"></h2>
                        <p id="detail-artist" class="text-muted truncate"></p>
                    </div>
                </div>
                <button onclick="closeDetailModal()" class="text-muted hover:text-white text-2xl ml-4">&times;</button>
            </div>

            <!-- Rating Section -->
            <div class="mt-6 flex items-center gap-8">
                <!-- Average Rating -->
                <div class="text-center">
                    <p class="text-xs text-muted uppercase mb-1">Average</p>
                    <div class="flex items-center gap-2">
                        <span id="detail-avg-rating" class="text-2xl font-bold text-accent">-</span>
                        <div class="text-muted">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="text-accent">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                        </div>
                    </div>
                    <p id="detail-rating-count" class="text-xs text-muted"></p>
                </div>

                <!-- Your Rating -->
                <div class="flex-1">
                    <p class="text-xs text-muted uppercase mb-2">Your Rating</p>
                    <div id="detail-star-rating" class="detail-star-rating-container" onmouseleave="resetDetailStarPreview()">
                        {% for i in range(5) %}
                        <div class="star-wrapper">
                            <svg class="star-bg" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            <svg class="star-fill" viewBox="0 0 24 24" style="clip-path: inset(0 100% 0 0);">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            <div class="star-quarters">
                                <div class="quarter q1" data-value="{{ i + 0.25 }}" onmouseenter="previewDetailRating({{ i + 0.25 }})" onclick="setDetailRating({{ i + 0.25 }})"></div>
                                <div class="quarter q2" data-value="{{ i + 0.5 }}" onmouseenter="previewDetailRating({{ i + 0.5 }})" onclick="setDetailRating({{ i + 0.5 }})"></div>
                                <div class="quarter q3" data-value="{{ i + 0.75 }}" onmouseenter="previewDetailRating({{ i + 0.75 }})" onclick="setDetailRating({{ i + 0.75 }})"></div>
                                <div class="quarter q4" data-value="{{ i + 1 }}" onmouseenter="previewDetailRating({{ i + 1 }})" onclick="setDetailRating({{ i + 1 }})"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <p id="detail-your-rating" class="text-xs text-muted mt-1">{% if session.user %}Click to rate{% else %}Sign in to rate{% endif %}</p>
                </div>
            </div>
        </div>

        <!-- Lists containing this item -->
        <div class="flex-1 overflow-y-auto p-6">
            <h3 class="text-sm font-semibold text-muted uppercase tracking-wider mb-4">Lists featuring this <span id="detail-type-label">item</span></h3>
            <div id="detail-lists" class="space-y-3">
                <p class="text-muted text-sm">Loading...</p>
            </div>
        </div>
    </div>
</div>

<!-- Export to Spotify Modal -->
{% if session.user %}
<div id="export-spotify-modal" class="fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center">
    <div class="bg-surface border border-border rounded-lg w-full max-w-lg mx-4 max-h-[85vh] flex flex-col">
        <div class="p-6 border-b border-border">
            <div class="flex justify-between items-center">
                <h3 class="font-semibold text-lg">Export to Spotify</h3>
                <button onclick="closeExportSpotifyModal()" class="text-muted hover:text-white text-2xl">&times;</button>
            </div>
        </div>

        <div id="export-content" class="flex-1 overflow-y-auto p-6">
            <div id="export-not-connected" class="hidden">
                <p class="text-muted mb-4">Connect your Spotify account to export this list as a playlist.</p>
                <a href="/connect/spotify" class="btn-spotify inline-flex items-center">
                    <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
                    Connect Spotify
                </a>
            </div>

            <div id="export-connected" class="hidden space-y-4">
                <p class="text-sm text-muted mb-4">Export "{{ list.title }}" ({{ items|length }} tracks) to Spotify:</p>

                <div>
                    <label class="flex items-center gap-3 p-4 bg-elevated rounded-lg cursor-pointer hover:bg-elevated/80 border border-transparent has-[:checked]:border-accent">
                        <input type="radio" name="export-dest" value="new" checked class="accent-accent">
                        <div>
                            <p class="font-medium">Create New Playlist</p>
                            <p class="text-xs text-muted">Create a fresh playlist in your Spotify</p>
                        </div>
                    </label>
                    <div id="new-playlist-name-container" class="mt-2 ml-7">
                        <input type="text" id="export-new-playlist-name" class="input-field" placeholder="Playlist name" value="{{ list.title }}">
                    </div>
                </div>

                <div>
                    <label class="flex items-center gap-3 p-4 bg-elevated rounded-lg cursor-pointer hover:bg-elevated/80 border border-transparent has-[:checked]:border-accent">
                        <input type="radio" name="export-dest" value="existing" class="accent-accent">
                        <div>
                            <p class="font-medium">Update Existing Playlist</p>
                            <p class="text-xs text-muted">Replace tracks in one of your playlists</p>
                        </div>
                    </label>
                    <div id="existing-playlist-container" class="mt-2 ml-7 hidden">
                        <select id="export-existing-playlist" class="input-field">
                            <option value="">Select a playlist...</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-border flex justify-end">
            <button id="export-confirm-btn" onclick="confirmExport()" class="btn-primary text-sm hidden">Export to Spotify</button>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<style>
/* Spotify button */
.btn-spotify {
    background: #1DB954;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    display: inline-flex;
    align-items: center;
    font-weight: 500;
    transition: background 0.2s;
}
.btn-spotify:hover {
    background: #1ed760;
}

.tile-menu-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 32px;
    height: 32px;
    background: rgba(0, 0, 0, 0.8);
    border-radius: 6px;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 10;
    cursor: pointer;
    border: none;
}
.tile-menu-btn:hover {
    background: rgba(0, 0, 0, 0.95);
}
.album-tile:hover .tile-menu-btn {
    opacity: 1;
}

.tile-menu {
    position: fixed;
    background: #1c2228;
    border: 1px solid #3a3f47;
    border-radius: 8px;
    padding: 6px;
    z-index: 100;
    min-width: 180px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}
.tile-menu button {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 10px 12px;
    text-align: left;
    color: #99aabb;
    font-size: 14px;
    border: none;
    background: none;
    border-radius: 6px;
    cursor: pointer;
}
.tile-menu button:hover {
    background: #242c34;
    color: white;
}

/* Star rating styles */
.star-rating-container {
    display: flex;
    gap: 4px;
}
.star-wrapper {
    position: relative;
    width: 36px;
    height: 36px;
    cursor: pointer;
}
.star-wrapper svg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}
.star-bg {
    fill: #3a3f47;
}
.star-fill {
    fill: #22d3ee;
    transition: clip-path 0.1s ease;
}
.star-quarters {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
}
.quarter {
    flex: 1;
    height: 100%;
}

/* User list items in modal */
.user-list-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #242c34;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.15s;
}
.user-list-item:hover {
    background: #2a343e;
}
.user-list-item.added {
    background: rgba(34, 211, 238, 0.1);
    border: 1px solid #22d3ee;
}

/* Like button styles */
.like-btn.liked {
    background: rgba(34, 211, 238, 0.1);
    border-color: #22d3ee;
    color: #22d3ee;
}
.like-btn.liked #like-icon {
    color: #22d3ee;
}

/* Detail modal star rating */
.detail-star-rating-container {
    display: flex;
    gap: 4px;
}
.detail-star-rating-container .star-wrapper {
    width: 28px;
    height: 28px;
}

/* Clickable tiles cursor */
.album-tile {
    cursor: pointer;
}
</style>

<script>
const listId = "{{ list.id }}";
let currentTileId = null;
let currentTrackData = null;
let currentRating = 0;
let selectedRating = 0;
let currentRatingType = 'album'; // 'album' or 'song'
let userLiked = false;
const isLoggedIn = {{ 'true' if session.user else 'false' }};

// Load like status on page load
document.addEventListener('DOMContentLoaded', loadLikeStatus);

function loadLikeStatus() {
    fetch(`/api/list/${listId}/like-status`)
        .then(res => res.json())
        .then(data => {
            userLiked = data.user_liked;
            // Update all like counts (mobile + desktop)
            document.querySelectorAll('.like-count').forEach(el => {
                el.textContent = data.like_count;
            });
            // Update all like buttons (mobile + desktop)
            document.querySelectorAll('.like-btn').forEach(likeBtn => {
                const likeIcon = likeBtn.querySelector('.like-icon');
                if (userLiked) {
                    likeBtn.classList.add('liked');
                    if (likeIcon) likeIcon.textContent = '♥';
                } else {
                    likeBtn.classList.remove('liked');
                    if (likeIcon) likeIcon.textContent = '♡';
                }
            });
        });
}

function toggleLike() {
    if (!isLoggedIn) {
        window.location.href = '/login';
        return;
    }

    const endpoint = userLiked ? `/api/list/${listId}/unlike` : `/api/list/${listId}/like`;
    fetch(endpoint, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                userLiked = !userLiked;
                loadLikeStatus();
            }
        });
}

// Close menu when clicking outside
document.addEventListener('click', (e) => {
    const menu = document.getElementById('tile-menu');
    if (!menu.classList.contains('hidden') && !e.target.closest('.tile-menu-btn')) {
        menu.classList.add('hidden');
    }
});

function openTileMenu(btn, itemId) {
    const menu = document.getElementById('tile-menu');
    const tile = btn.closest('.album-tile');
    const rect = btn.getBoundingClientRect();

    currentTileId = itemId;
    currentTrackData = {
        trackId: tile.dataset.trackId,
        trackName: tile.dataset.trackName,
        artistName: tile.dataset.artistName,
        albumName: tile.dataset.albumName,
        albumArt: tile.dataset.albumArt
    };

    // Position menu below button
    menu.style.top = `${rect.bottom + 8}px`;
    menu.style.left = `${rect.left - 140}px`;

    // Keep menu in viewport
    const menuRect = menu.getBoundingClientRect();
    if (menuRect.right > window.innerWidth) {
        menu.style.left = `${window.innerWidth - 200}px`;
    }

    menu.classList.remove('hidden');
}

function openAddToListModal() {
    document.getElementById('tile-menu').classList.add('hidden');
    document.getElementById('add-to-list-modal').classList.remove('hidden');
    loadUserLists();
}

function closeAddToListModal() {
    document.getElementById('add-to-list-modal').classList.add('hidden');
}

function loadUserLists() {
    const container = document.getElementById('user-lists-container');
    container.innerHTML = '<p class="text-muted text-sm">Loading your lists...</p>';

    fetch('/api/user/lists')
        .then(res => res.json())
        .then(data => {
            if (data.lists && data.lists.length > 0) {
                container.innerHTML = data.lists.map(list => `
                    <div class="user-list-item" onclick="addTrackToList('${list.id}', this)">
                        <div class="w-10 h-10 rounded bg-elevated flex items-center justify-center text-muted">
                            ${list.preview_image ? `<img src="${list.preview_image}" class="w-full h-full object-cover rounded">` : '♪'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-sm truncate">${list.title}</p>
                            <p class="text-xs text-muted">${list.item_count} songs</p>
                        </div>
                        <span class="add-status text-accent text-xs hidden">Added!</span>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-muted text-sm text-center py-4">You don\'t have any lists yet</p>';
            }
        })
        .catch(() => {
            container.innerHTML = '<p class="text-red-400 text-sm">Failed to load lists</p>';
        });
}

function addTrackToList(targetListId, element) {
    fetch(`/api/list/${targetListId}/add`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            track_id: currentTrackData.trackId,
            track_name: currentTrackData.trackName,
            artist_name: currentTrackData.artistName,
            album_name: currentTrackData.albumName,
            album_art_url: currentTrackData.albumArt
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            element.classList.add('added');
            element.querySelector('.add-status').classList.remove('hidden');
            // Update count
            const countEl = element.querySelector('.text-xs.text-muted');
            const currentCount = parseInt(countEl.textContent) || 0;
            countEl.textContent = `${currentCount + 1} songs`;
        } else {
            alert(data.error || 'Failed to add to list');
        }
    });
}

function createNewListWithTrack() {
    const title = prompt('Enter a name for your new list:');
    if (!title) return;

    fetch('/api/list/create-with-track', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            title: title,
            track: currentTrackData
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success && data.list_id) {
            closeAddToListModal();
            window.location.href = `/list/${data.list_id}/edit`;
        } else {
            alert(data.error || 'Failed to create list');
        }
    });
}

function openRatingModal(type) {
    document.getElementById('tile-menu').classList.add('hidden');
    currentRatingType = type;

    // Update modal title and info based on type
    const isAlbum = type === 'album';
    document.getElementById('rating-modal-title').textContent = isAlbum ? 'Rate Album' : 'Rate Song';
    document.getElementById('rating-album-art').src = currentTrackData.albumArt || '';
    document.getElementById('rating-item-name').textContent = isAlbum ? currentTrackData.albumName : currentTrackData.trackName;
    document.getElementById('rating-artist-name').textContent = currentTrackData.artistName;

    // Load existing rating
    loadExistingRating();

    document.getElementById('rating-modal').classList.remove('hidden');
}

function closeRatingModal() {
    document.getElementById('rating-modal').classList.add('hidden');
    selectedRating = 0;
    updateStarDisplay(0);
}

function loadExistingRating() {
    const endpoint = currentRatingType === 'album'
        ? `/api/album/rating?album=${encodeURIComponent(currentTrackData.albumName)}&artist=${encodeURIComponent(currentTrackData.artistName)}`
        : `/api/song/rating?track=${encodeURIComponent(currentTrackData.trackName)}&artist=${encodeURIComponent(currentTrackData.artistName)}`;

    fetch(endpoint)
        .then(res => res.json())
        .then(data => {
            if (data.rating) {
                selectedRating = data.rating;
                updateStarDisplay(selectedRating);
                document.getElementById('rating-display').textContent = `${selectedRating} stars`;
            } else {
                selectedRating = 0;
                updateStarDisplay(0);
                document.getElementById('rating-display').textContent = 'Click to rate';
            }
        });
}

function previewRating(value) {
    updateStarDisplay(value);
    document.getElementById('rating-display').textContent = `${value} stars`;
}

function resetStarPreview() {
    updateStarDisplay(selectedRating);
    if (selectedRating > 0) {
        document.getElementById('rating-display').textContent = `${selectedRating} stars`;
    } else {
        document.getElementById('rating-display').textContent = 'Click to rate';
    }
}

function setRating(value) {
    selectedRating = value;
    updateStarDisplay(value);
    document.getElementById('rating-display').textContent = `${value} stars`;
}

function updateStarDisplay(value) {
    const stars = document.querySelectorAll('.star-wrapper');
    stars.forEach((star, index) => {
        const fillSvg = star.querySelector('.star-fill');
        const starValue = index + 1;

        if (value >= starValue) {
            // Full star
            fillSvg.style.clipPath = 'inset(0 0% 0 0)';
        } else if (value > index) {
            // Partial star - use adjusted percentages for better visual fill
            // Values are symmetric: 0.25 and 0.75 should look like mirror images
            const fraction = value - index;
            let visualPercentage;
            if (fraction <= 0.25) {
                visualPercentage = 30; // 0.25 star shows 30% width
            } else if (fraction <= 0.5) {
                visualPercentage = 50; // 0.5 star shows 50% width (center)
            } else if (fraction <= 0.75) {
                visualPercentage = 70; // 0.75 star shows 70% width (symmetric to 30%)
            } else {
                visualPercentage = 100;
            }
            fillSvg.style.clipPath = `inset(0 ${100 - visualPercentage}% 0 0)`;
        } else {
            // Empty star
            fillSvg.style.clipPath = 'inset(0 100% 0 0)';
        }
    });
}

function clearRating() {
    selectedRating = 0;
    updateStarDisplay(0);
    document.getElementById('rating-display').textContent = 'Click to rate';
}

function saveRating() {
    const endpoint = currentRatingType === 'album' ? '/api/album/rating' : '/api/song/rating';
    const body = currentRatingType === 'album'
        ? {
            album_name: currentTrackData.albumName,
            artist_name: currentTrackData.artistName,
            album_art_url: currentTrackData.albumArt,
            rating: selectedRating
        }
        : {
            track_name: currentTrackData.trackName,
            artist_name: currentTrackData.artistName,
            album_art_url: currentTrackData.albumArt,
            rating: selectedRating
        };

    fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            closeRatingModal();
            showToast(selectedRating > 0 ? `Rated ${selectedRating} stars` : 'Rating cleared');
        } else {
            alert(data.error || 'Failed to save rating');
        }
    });
}

function showToast(message) {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-accent text-base px-4 py-2 rounded-lg font-medium text-sm z-50';
    toast.textContent = message;
    document.body.appendChild(toast);

    // Remove after 2 seconds
    setTimeout(() => {
        toast.remove();
    }, 2000);
}

function duplicateList() {
    if (!confirm('Create a copy of this list to your account?')) return;

    fetch(`/api/list/${listId}/duplicate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success && data.new_list_id) {
            window.location.href = `/list/${data.new_list_id}/edit`;
        } else {
            alert('Failed to copy list');
        }
    });
}

// Close modals on backdrop click
document.getElementById('add-to-list-modal').addEventListener('click', function(e) {
    if (e.target === this) closeAddToListModal();
});
document.getElementById('rating-modal').addEventListener('click', function(e) {
    if (e.target === this) closeRatingModal();
});

// Click on tiles to open detail modal (for non-owner, or when not dragging)
document.querySelectorAll('.album-tile').forEach(tile => {
    tile.addEventListener('click', function(e) {
        // Don't trigger if clicking the menu button
        if (e.target.closest('.tile-menu-btn')) return;

        const trackName = this.dataset.trackName;
        const artistName = this.dataset.artistName;
        const albumName = this.dataset.albumName;
        const albumArt = this.dataset.albumArt;

        // Open song detail modal
        openSongDetailModal({
            name: trackName,
            artist: artistName,
            album: albumName,
            album_art: albumArt
        });
    });
});

// Song/Album detail modal functions
let detailData = null;
let detailRating = 0;

function openSongDetailModal(item) {
    detailData = { type: 'song', ...item };
    detailRating = 0;

    document.getElementById('detail-type').textContent = 'song';
    document.getElementById('detail-type-label').textContent = 'song';
    document.getElementById('detail-name').textContent = item.name;
    document.getElementById('detail-artist').textContent = item.artist;
    document.getElementById('detail-art').src = item.album_art || '';
    document.getElementById('detail-avg-rating').textContent = '-';
    document.getElementById('detail-rating-count').textContent = '';
    document.getElementById('detail-lists').innerHTML = '<p class="text-muted text-sm">Loading...</p>';

    updateDetailStarDisplay(0);
    document.getElementById('detail-your-rating').textContent = isLoggedIn ? 'Click to rate' : 'Sign in to rate';

    document.getElementById('detail-modal').classList.remove('hidden');

    // Load details
    loadDetailInfo('song', item);
}

function closeDetailModal() {
    document.getElementById('detail-modal').classList.add('hidden');
    detailData = null;
}

function loadDetailInfo(type, item) {
    const params = type === 'song'
        ? `type=song&name=${encodeURIComponent(item.name)}&artist=${encodeURIComponent(item.artist)}`
        : `type=album&name=${encodeURIComponent(item.name)}&artist=${encodeURIComponent(item.artist)}`;

    fetch(`/api/item/details?${params}`)
        .then(res => res.json())
        .then(data => {
            // Average rating
            if (data.avg_rating) {
                document.getElementById('detail-avg-rating').textContent = data.avg_rating.toFixed(1);
                document.getElementById('detail-rating-count').textContent = `${data.rating_count} rating${data.rating_count !== 1 ? 's' : ''}`;
            } else {
                document.getElementById('detail-avg-rating').textContent = '-';
                document.getElementById('detail-rating-count').textContent = 'No ratings yet';
            }

            // Your rating
            if (data.user_rating) {
                detailRating = data.user_rating;
                updateDetailStarDisplay(detailRating);
                document.getElementById('detail-your-rating').textContent = `${detailRating} stars`;
            }

            // Lists containing this item
            if (data.lists && data.lists.length > 0) {
                document.getElementById('detail-lists').innerHTML = data.lists.map(l => `
                    <a href="/list/${l.id}" class="block card p-3 hover:border-accent transition">
                        <div class="flex items-center gap-3">
                            ${l.preview_image ? `<img src="${l.preview_image}" class="w-10 h-10 rounded object-cover bg-elevated">` : '<div class="w-10 h-10 rounded bg-elevated flex items-center justify-center text-muted">♪</div>'}
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-sm text-white truncate">${l.title}</p>
                                <p class="text-xs text-muted">by ${l.username} · ${l.item_count} songs${l.like_count ? ` · <span class="text-accent">♥ ${l.like_count}</span>` : ''}</p>
                            </div>
                        </div>
                    </a>
                `).join('');
            } else {
                document.getElementById('detail-lists').innerHTML = '<p class="text-muted text-sm">No lists feature this ' + type + ' yet</p>';
            }
        });
}

function previewDetailRating(value) {
    if (!isLoggedIn) return;
    updateDetailStarDisplay(value);
    document.getElementById('detail-your-rating').textContent = `${value} stars`;
}

function resetDetailStarPreview() {
    updateDetailStarDisplay(detailRating);
    if (detailRating > 0) {
        document.getElementById('detail-your-rating').textContent = `${detailRating} stars`;
    } else {
        document.getElementById('detail-your-rating').textContent = isLoggedIn ? 'Click to rate' : 'Sign in to rate';
    }
}

function setDetailRating(value) {
    if (!isLoggedIn) {
        window.location.href = '/login';
        return;
    }

    detailRating = value;
    updateDetailStarDisplay(value);
    document.getElementById('detail-your-rating').textContent = `${value} stars`;

    // Save rating
    const endpoint = detailData.type === 'album' ? '/api/album/rating' : '/api/song/rating';
    const body = detailData.type === 'album'
        ? { album_name: detailData.name, artist_name: detailData.artist, album_art_url: detailData.album_art, rating: value }
        : { track_name: detailData.name, artist_name: detailData.artist, album_art_url: detailData.album_art, rating: value };

    fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    }).then(() => {
        loadDetailInfo(detailData.type, detailData);
    });
}

function updateDetailStarDisplay(value) {
    const stars = document.querySelectorAll('#detail-star-rating .star-wrapper');
    stars.forEach((star, index) => {
        const fillSvg = star.querySelector('.star-fill');
        const starValue = index + 1;

        if (value >= starValue) {
            fillSvg.style.clipPath = 'inset(0 0% 0 0)';
        } else if (value > index) {
            const fraction = value - index;
            let visualPercentage;
            if (fraction <= 0.25) {
                visualPercentage = 30;
            } else if (fraction <= 0.5) {
                visualPercentage = 50;
            } else if (fraction <= 0.75) {
                visualPercentage = 70;
            } else {
                visualPercentage = 100;
            }
            fillSvg.style.clipPath = `inset(0 ${100 - visualPercentage}% 0 0)`;
        } else {
            fillSvg.style.clipPath = 'inset(0 100% 0 0)';
        }
    });
}

// Close detail modal on backdrop click
document.getElementById('detail-modal').addEventListener('click', function(e) {
    if (e.target === this) closeDetailModal();
});

// ============== HOVER RATING FUNCTIONS (desktop only) ==============
// Store ratings for each item by name+artist
const hoverRatingsCache = {};

// Load ALL ratings in a single batch request on page load
document.addEventListener('DOMContentLoaded', function() {
    if (!isLoggedIn) return;

    const overlays = document.querySelectorAll('.hover-overlay');
    if (overlays.length === 0) return;

    // Collect all items to fetch ratings for
    const items = [];
    overlays.forEach(overlay => {
        items.push({
            type: overlay.dataset.type,
            name: overlay.dataset.name,
            artist: overlay.dataset.artist
        });
    });

    // Single batch request instead of N individual requests
    fetch('/api/ratings/batch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items })
    })
    .then(res => res.json())
    .then(data => {
        // Cache all ratings
        Object.assign(hoverRatingsCache, data.ratings);

        // Apply ratings to overlays
        overlays.forEach(overlay => {
            const key = `${overlay.dataset.type}:${overlay.dataset.name}:${overlay.dataset.artist}`;
            const rating = hoverRatingsCache[key] || 0;
            displayHoverRating(overlay, rating);
        });
    })
    .catch(() => {
        // On error, just leave stars empty
    });
});

function displayHoverRating(overlay, rating) {
    const starsContainer = overlay.querySelector('.hover-stars');
    if (!starsContainer) return;

    starsContainer.dataset.currentRating = rating;
    const stars = starsContainer.querySelectorAll('.hover-star');
    const ratingText = starsContainer.querySelector('.hover-rating-text');

    stars.forEach((star, index) => {
        const fillPath = star.querySelector('.star-fill-path');
        if (rating >= index + 1) {
            fillPath.style.opacity = '1';
        } else {
            fillPath.style.opacity = '0';
        }
    });

    if (rating > 0 && ratingText) {
        ratingText.textContent = `${rating}★`;
    } else if (ratingText) {
        ratingText.textContent = '';
    }
}

function previewHoverStar(starEl, value) {
    const starsContainer = starEl.closest('.hover-stars');
    const stars = starsContainer.querySelectorAll('.hover-star');
    const ratingText = starsContainer.querySelector('.hover-rating-text');

    stars.forEach((star, index) => {
        const fillPath = star.querySelector('.star-fill-path');
        if (value >= index + 1) {
            fillPath.style.opacity = '1';
        } else {
            fillPath.style.opacity = '0';
        }
    });

    if (ratingText) {
        ratingText.textContent = `${value}★`;
    }
}

function resetHoverStars(starsContainer) {
    const currentRating = parseInt(starsContainer.dataset.currentRating) || 0;
    const stars = starsContainer.querySelectorAll('.hover-star');
    const ratingText = starsContainer.querySelector('.hover-rating-text');

    stars.forEach((star, index) => {
        const fillPath = star.querySelector('.star-fill-path');
        if (currentRating >= index + 1) {
            fillPath.style.opacity = '1';
        } else {
            fillPath.style.opacity = '0';
        }
    });

    if (currentRating > 0 && ratingText) {
        ratingText.textContent = `${currentRating}★`;
    } else if (ratingText) {
        ratingText.textContent = '';
    }
}

function setHoverRating(starEl, value) {
    if (!isLoggedIn) {
        window.location.href = '/login';
        return;
    }

    const starsContainer = starEl.closest('.hover-stars');
    const overlay = starEl.closest('.hover-overlay');
    const name = overlay.dataset.name;
    const artist = overlay.dataset.artist;
    const art = overlay.dataset.art;
    const type = overlay.dataset.type;

    // Update display immediately
    starsContainer.dataset.currentRating = value;
    displayHoverRating(overlay, value);

    // Save to server
    const endpoint = type === 'album' ? '/api/album/rating' : '/api/song/rating';
    const body = type === 'album'
        ? { album_name: name, artist_name: artist, album_art_url: art, rating: value }
        : { track_name: name, artist_name: artist, album_art_url: art, rating: value };

    fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Update cache
            const cacheKey = `${type}:${name}:${artist}`;
            hoverRatingsCache[cacheKey] = value;
            showToast(`Rated ${value} stars`);
        }
    });
}

// ============== SPOTIFY EXPORT FUNCTIONS ==============
let spotifyPlaylists = [];

function openExportSpotifyModal() {
    const modal = document.getElementById('export-spotify-modal');
    if (!modal) return;

    modal.classList.remove('hidden');

    // Check if user has Spotify connected
    fetch('/api/spotify/connected')
        .then(res => res.json())
        .then(data => {
            if (data.connected) {
                document.getElementById('export-not-connected').classList.add('hidden');
                document.getElementById('export-connected').classList.remove('hidden');
                document.getElementById('export-confirm-btn').classList.remove('hidden');
                loadUserSpotifyPlaylists();
            } else {
                document.getElementById('export-not-connected').classList.remove('hidden');
                document.getElementById('export-connected').classList.add('hidden');
                document.getElementById('export-confirm-btn').classList.add('hidden');
            }
        })
        .catch(() => {
            document.getElementById('export-not-connected').classList.remove('hidden');
            document.getElementById('export-connected').classList.add('hidden');
            document.getElementById('export-confirm-btn').classList.add('hidden');
        });

    // Handle radio button changes
    document.querySelectorAll('input[name="export-dest"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'new') {
                document.getElementById('new-playlist-name-container').classList.remove('hidden');
                document.getElementById('existing-playlist-container').classList.add('hidden');
            } else {
                document.getElementById('new-playlist-name-container').classList.add('hidden');
                document.getElementById('existing-playlist-container').classList.remove('hidden');
            }
        });
    });
}

function closeExportSpotifyModal() {
    const modal = document.getElementById('export-spotify-modal');
    if (modal) modal.classList.add('hidden');
}

function loadUserSpotifyPlaylists() {
    fetch('/api/spotify/my-playlists')
        .then(res => res.json())
        .then(data => {
            spotifyPlaylists = data.playlists || [];
            const select = document.getElementById('export-existing-playlist');
            select.innerHTML = '<option value="">Select a playlist...</option>' +
                spotifyPlaylists.map(p => `<option value="${p.id}">${escapeHtml(p.name)} (${p.track_count} tracks)</option>`).join('');
        });
}

function confirmExport() {
    const destType = document.querySelector('input[name="export-dest"]:checked').value;
    const btn = document.getElementById('export-confirm-btn');
    btn.disabled = true;
    btn.textContent = 'Exporting...';

    const payload = {
        list_id: listId
    };

    if (destType === 'new') {
        payload.new_playlist_name = document.getElementById('export-new-playlist-name').value || '{{ list.title }}';
    } else {
        const playlistId = document.getElementById('export-existing-playlist').value;
        if (!playlistId) {
            alert('Please select a playlist');
            btn.disabled = false;
            btn.textContent = 'Export to Spotify';
            return;
        }
        payload.playlist_id = playlistId;
    }

    fetch('/api/spotify/export', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            closeExportSpotifyModal();
            if (data.playlist_url) {
                showToast(`Exported ${data.tracks_exported} tracks to Spotify!`);
                if (confirm('Playlist created! Open in Spotify?')) {
                    window.open(data.playlist_url, '_blank');
                }
            } else {
                showToast(`Updated playlist with ${data.tracks_exported} tracks!`);
            }
        } else {
            alert('Export failed: ' + (data.error || 'Unknown error'));
            btn.disabled = false;
            btn.textContent = 'Export to Spotify';
        }
    })
    .catch(err => {
        alert('Export failed');
        btn.disabled = false;
        btn.textContent = 'Export to Spotify';
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close export modal on backdrop click
const exportModal = document.getElementById('export-spotify-modal');
if (exportModal) {
    exportModal.addEventListener('click', function(e) {
        if (e.target === this) closeExportSpotifyModal();
    });
}
</script>

{% if is_owner and items %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
const albumGrid = document.getElementById('album-grid');

// Detect if device is touch-only (mobile)
const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

// Only enable drag-and-drop on desktop
if (!isTouchDevice) {
    new Sortable(albumGrid, {
        animation: 150,
        ghostClass: 'opacity-50',
        onEnd: function(evt) {
            updateRankBadges();

            const items = albumGrid.querySelectorAll('.album-tile');
            const order = Array.from(items).map((item, index) => ({
                item_id: item.dataset.id,
                position: index + 1
            }));

            fetch(`/api/list/${listId}/reorder-all`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order })
            });
        }
    });

    // Update cursor styles for desktop
    albumGrid.querySelectorAll('.album-tile').forEach(tile => {
        tile.classList.add('cursor-grab');
    });
}

function updateRankBadges() {
    const badges = albumGrid.querySelectorAll('.rank-badge');
    badges.forEach((badge, index) => {
        badge.textContent = index + 1;
    });
}
</script>
{% endif %}
{% endblock %}
