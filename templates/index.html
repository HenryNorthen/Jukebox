{% extends "base.html" %}

{% block content %}
<!-- Hero Section -->
<div class="text-center py-12 mb-10">
    <h1 class="text-4xl font-bold text-white mb-3">Jukeboxd</h1>
    <p class="text-lg text-muted mb-8">Create and share your music lists. Discover what others are listening to.</p>

    {% if not session.user %}
    <div class="flex justify-center gap-4">
        <a href="{{ url_for('signup') }}" class="btn-primary">Get Started</a>
        <a href="{{ url_for('login') }}" class="btn-secondary">Sign In</a>
    </div>
    {% endif %}
</div>

<!-- Unified Search -->
<div class="max-w-xl mx-auto mb-12 relative">
    <input type="text" id="unified-search" placeholder="Search..." class="input-field w-full" autocomplete="off">
    <div id="search-results-dropdown" class="hidden absolute left-0 right-0 top-full mt-2 bg-surface border border-border rounded-lg shadow-xl z-50 max-h-[70vh] overflow-y-auto">
        <!-- Results will be populated by JS -->
    </div>
</div>

<!-- Popular Lists -->
{% if public_lists %}
<div>
    <h2 class="text-sm font-semibold text-muted uppercase tracking-wider mb-5">Recent Public Lists</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
        {% for list in public_lists %}
        <a href="{{ url_for('view_list', list_id=list.id) }}" class="card p-5 hover:border-accent transition block">
            <!-- Album art preview -->
            {% if list.preview_images %}
            <div class="flex gap-1 mb-4">
                {% for img in list.preview_images[:4] %}
                <div class="w-12 h-12 rounded overflow-hidden bg-elevated">
                    <img src="{{ img }}" alt="" class="w-full h-full object-cover">
                </div>
                {% endfor %}
                {% if list.item_count > 4 %}
                <div class="w-12 h-12 rounded bg-elevated flex items-center justify-center">
                    <span class="text-muted text-xs font-medium">+{{ list.item_count - 4 }}</span>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="flex gap-1 mb-4">
                <div class="w-12 h-12 rounded bg-elevated flex items-center justify-center">
                    <span class="text-muted text-lg">♪</span>
                </div>
            </div>
            {% endif %}

            <h3 class="font-semibold text-white leading-tight">{{ list.title }}</h3>
            <p class="text-xs text-muted mt-1">
                by <span class="text-accent">{{ list.profiles.username if list.profiles else 'Unknown' }}</span>
            </p>
            {% if list.description %}
            <p class="text-sm text-muted mt-2 line-clamp-2">{{ list.description[:80] }}{% if list.description|length > 80 %}...{% endif %}</p>
            {% endif %}
            <p class="text-xs text-muted mt-3">
                {{ list.item_count }} song{{ 's' if list.item_count != 1 else '' }} · {{ 'Ranked' if list.is_ranked else 'Unranked' }}
                {% if list.like_count %}<span class="text-accent ml-2">♥ {{ list.like_count }}</span>{% endif %}
            </p>
        </a>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="card text-center py-12 px-6">
    <p class="text-muted">No public lists yet. Be the first to create one!</p>
    {% if session.user %}
    <a href="{{ url_for('create_list') }}" class="btn-primary mt-4 inline-block">Create a List</a>
    {% endif %}
</div>
{% endif %}

<!-- Song/Album Detail Modal -->
<div id="detail-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center">
    <div class="bg-surface border border-border rounded-lg w-full max-w-2xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-6 border-b border-border">
            <div class="flex justify-between items-start">
                <div class="flex gap-4">
                    <img id="detail-art" src="" alt="" class="w-24 h-24 rounded-lg object-cover bg-elevated flex-shrink-0">
                    <div class="flex-1 min-w-0">
                        <p id="detail-type" class="text-xs text-muted uppercase tracking-wider mb-1"></p>
                        <h2 id="detail-name" class="text-xl font-bold text-white truncate"></h2>
                        <p id="detail-artist" class="text-muted truncate"></p>
                    </div>
                </div>
                <button onclick="closeDetailModal()" class="text-muted hover:text-white text-2xl ml-4">&times;</button>
            </div>

            <!-- Rating Section -->
            <div class="mt-6 flex items-center gap-8">
                <!-- Average Rating -->
                <div class="text-center">
                    <p class="text-xs text-muted uppercase mb-1">Average</p>
                    <div class="flex items-center gap-2">
                        <span id="detail-avg-rating" class="text-2xl font-bold text-accent">-</span>
                        <div class="text-muted">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="text-accent">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                        </div>
                    </div>
                    <p id="detail-rating-count" class="text-xs text-muted"></p>
                </div>

                <!-- Your Rating -->
                <div class="flex-1">
                    <p class="text-xs text-muted uppercase mb-2">Your Rating</p>
                    <div id="detail-star-rating" class="star-rating-container" onmouseleave="resetDetailStarPreview()">
                        {% for i in range(5) %}
                        <div class="star-wrapper">
                            <svg class="star-bg" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            <svg class="star-fill" viewBox="0 0 24 24" style="clip-path: inset(0 100% 0 0);">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            <div class="star-quarters">
                                <div class="quarter q1" data-value="{{ i + 0.25 }}" onmouseenter="previewDetailRating({{ i + 0.25 }})" onclick="setDetailRating({{ i + 0.25 }})"></div>
                                <div class="quarter q2" data-value="{{ i + 0.5 }}" onmouseenter="previewDetailRating({{ i + 0.5 }})" onclick="setDetailRating({{ i + 0.5 }})"></div>
                                <div class="quarter q3" data-value="{{ i + 0.75 }}" onmouseenter="previewDetailRating({{ i + 0.75 }})" onclick="setDetailRating({{ i + 0.75 }})"></div>
                                <div class="quarter q4" data-value="{{ i + 1 }}" onmouseenter="previewDetailRating({{ i + 1 }})" onclick="setDetailRating({{ i + 1 }})"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <p id="detail-your-rating" class="text-xs text-muted mt-1">{% if session.user %}Click to rate{% else %}Sign in to rate{% endif %}</p>
                </div>
            </div>
        </div>

        <!-- Lists containing this item -->
        <div class="flex-1 overflow-y-auto p-6">
            <h3 class="text-sm font-semibold text-muted uppercase tracking-wider mb-4">Lists featuring this <span id="detail-type-label">item</span></h3>
            <div id="detail-lists" class="space-y-3">
                <p class="text-muted text-sm">Loading...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
/* Star rating styles for detail modal */
.star-rating-container {
    display: flex;
    gap: 4px;
}
.star-wrapper {
    position: relative;
    width: 28px;
    height: 28px;
    cursor: pointer;
}
.star-wrapper svg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}
.star-bg {
    fill: #3a3f47;
}
.star-fill {
    fill: #22d3ee;
    transition: clip-path 0.1s ease;
}
.star-quarters {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
}
.quarter {
    flex: 1;
    height: 100%;
}

/* Search result item styles */
.search-category {
    padding: 8px 16px;
    background: #242c34;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #99aabb;
}
.search-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px;
    cursor: pointer;
    transition: background 0.15s;
}
.search-item:hover {
    background: #242c34;
}
.search-item img {
    width: 40px;
    height: 40px;
    border-radius: 4px;
    object-fit: cover;
    background: #242c34;
}
.search-item .placeholder-icon {
    width: 40px;
    height: 40px;
    border-radius: 4px;
    background: #242c34;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #99aabb;
    font-size: 18px;
}
</style>

<script>
let searchTimeout;
let detailData = null;
let detailRating = 0;
const isLoggedIn = {{ 'true' if session.user else 'false' }};

const searchInput = document.getElementById('unified-search');
const searchDropdown = document.getElementById('search-results-dropdown');

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('#unified-search') && !e.target.closest('#search-results-dropdown')) {
        searchDropdown.classList.add('hidden');
    }
});

searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();
    if (query.length < 2) {
        searchDropdown.classList.add('hidden');
        return;
    }

    searchTimeout = setTimeout(() => {
        fetch(`/api/search/unified?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                renderSearchResults(data);
            });
    }, 300);
});

searchInput.addEventListener('focus', function() {
    if (this.value.trim().length >= 2) {
        searchDropdown.classList.remove('hidden');
    }
});

function renderSearchResults(data) {
    let html = '';

    // Profiles
    if (data.profiles && data.profiles.length > 0) {
        html += '<div class="search-category">Profiles</div>';
        data.profiles.forEach(p => {
            html += `
                <a href="/u/${p.username}" class="search-item">
                    <div class="placeholder-icon">${p.username[0].toUpperCase()}</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate">${p.username}</p>
                        <p class="text-xs text-muted">${p.list_count || 0} public lists</p>
                    </div>
                </a>
            `;
        });
    }

    // Lists
    if (data.lists && data.lists.length > 0) {
        html += '<div class="search-category">Lists</div>';
        data.lists.forEach(l => {
            html += `
                <a href="/list/${l.id}" class="search-item">
                    ${l.preview_image ? `<img src="${l.preview_image}" alt="">` : '<div class="placeholder-icon">♪</div>'}
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate">${l.title}</p>
                        <p class="text-xs text-muted">by ${l.username} · ${l.item_count} songs${l.like_count ? ` · ♥ ${l.like_count}` : ''}</p>
                    </div>
                </a>
            `;
        });
    }

    // Songs
    if (data.songs && data.songs.length > 0) {
        html += '<div class="search-category">Songs</div>';
        data.songs.forEach(s => {
            html += `
                <div class="search-item" onclick='openDetailModal("song", ${JSON.stringify(s).replace(/'/g, "&#39;")})'>
                    ${s.album_art ? `<img src="${s.album_art}" alt="">` : '<div class="placeholder-icon">♪</div>'}
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate">${s.name}</p>
                        <p class="text-xs text-muted truncate">${s.artist}</p>
                    </div>
                </div>
            `;
        });
    }

    // Albums
    if (data.albums && data.albums.length > 0) {
        html += '<div class="search-category">Albums</div>';
        data.albums.forEach(a => {
            html += `
                <div class="search-item" onclick='openDetailModal("album", ${JSON.stringify(a).replace(/'/g, "&#39;")})'>
                    ${a.album_art ? `<img src="${a.album_art}" alt="">` : '<div class="placeholder-icon">♪</div>'}
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate">${a.name}</p>
                        <p class="text-xs text-muted truncate">${a.artist}</p>
                    </div>
                </div>
            `;
        });
    }

    if (!html) {
        html = '<p class="p-4 text-muted text-sm text-center">No results found</p>';
    }

    searchDropdown.innerHTML = html;
    searchDropdown.classList.remove('hidden');
}

function openDetailModal(type, item) {
    searchDropdown.classList.add('hidden');
    detailData = { type, ...item };
    detailRating = 0;

    document.getElementById('detail-type').textContent = type;
    document.getElementById('detail-type-label').textContent = type;
    document.getElementById('detail-name').textContent = item.name;
    document.getElementById('detail-artist').textContent = item.artist;
    document.getElementById('detail-art').src = item.album_art || '';
    document.getElementById('detail-avg-rating').textContent = '-';
    document.getElementById('detail-rating-count').textContent = '';
    document.getElementById('detail-lists').innerHTML = '<p class="text-muted text-sm">Loading...</p>';

    updateDetailStarDisplay(0);
    document.getElementById('detail-your-rating').textContent = isLoggedIn ? 'Click to rate' : 'Sign in to rate';

    document.getElementById('detail-modal').classList.remove('hidden');

    // Load details
    loadDetailInfo(type, item);
}

function closeDetailModal() {
    document.getElementById('detail-modal').classList.add('hidden');
    detailData = null;
}

function loadDetailInfo(type, item) {
    // Load average rating and lists containing this item
    const params = type === 'song'
        ? `type=song&name=${encodeURIComponent(item.name)}&artist=${encodeURIComponent(item.artist)}`
        : `type=album&name=${encodeURIComponent(item.name)}&artist=${encodeURIComponent(item.artist)}`;

    fetch(`/api/item/details?${params}`)
        .then(res => res.json())
        .then(data => {
            // Average rating
            if (data.avg_rating) {
                document.getElementById('detail-avg-rating').textContent = data.avg_rating.toFixed(1);
                document.getElementById('detail-rating-count').textContent = `${data.rating_count} rating${data.rating_count !== 1 ? 's' : ''}`;
            } else {
                document.getElementById('detail-avg-rating').textContent = '-';
                document.getElementById('detail-rating-count').textContent = 'No ratings yet';
            }

            // Your rating
            if (data.user_rating) {
                detailRating = data.user_rating;
                updateDetailStarDisplay(detailRating);
                document.getElementById('detail-your-rating').textContent = `${detailRating} stars`;
            }

            // Lists containing this item
            if (data.lists && data.lists.length > 0) {
                document.getElementById('detail-lists').innerHTML = data.lists.map(l => `
                    <a href="/list/${l.id}" class="block card p-3 hover:border-accent transition">
                        <div class="flex items-center gap-3">
                            ${l.preview_image ? `<img src="${l.preview_image}" class="w-10 h-10 rounded object-cover bg-elevated">` : '<div class="w-10 h-10 rounded bg-elevated flex items-center justify-center text-muted">♪</div>'}
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-sm text-white truncate">${l.title}</p>
                                <p class="text-xs text-muted">by ${l.username} · ${l.item_count} songs${l.like_count ? ` · <span class="text-accent">♥ ${l.like_count}</span>` : ''}</p>
                            </div>
                        </div>
                    </a>
                `).join('');
            } else {
                document.getElementById('detail-lists').innerHTML = '<p class="text-muted text-sm">No lists feature this ' + type + ' yet</p>';
            }
        });
}

function previewDetailRating(value) {
    if (!isLoggedIn) return;
    updateDetailStarDisplay(value);
    document.getElementById('detail-your-rating').textContent = `${value} stars`;
}

function resetDetailStarPreview() {
    updateDetailStarDisplay(detailRating);
    if (detailRating > 0) {
        document.getElementById('detail-your-rating').textContent = `${detailRating} stars`;
    } else {
        document.getElementById('detail-your-rating').textContent = isLoggedIn ? 'Click to rate' : 'Sign in to rate';
    }
}

function setDetailRating(value) {
    if (!isLoggedIn) {
        window.location.href = '/login';
        return;
    }

    detailRating = value;
    updateDetailStarDisplay(value);
    document.getElementById('detail-your-rating').textContent = `${value} stars`;

    // Save rating
    const endpoint = detailData.type === 'album' ? '/api/album/rating' : '/api/song/rating';
    const body = detailData.type === 'album'
        ? { album_name: detailData.name, artist_name: detailData.artist, album_art_url: detailData.album_art, rating: value }
        : { track_name: detailData.name, artist_name: detailData.artist, album_art_url: detailData.album_art, rating: value };

    fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    }).then(() => {
        // Refresh details to update average
        loadDetailInfo(detailData.type, detailData);
    });
}

function updateDetailStarDisplay(value) {
    const stars = document.querySelectorAll('#detail-star-rating .star-wrapper');
    stars.forEach((star, index) => {
        const fillSvg = star.querySelector('.star-fill');
        const starValue = index + 1;

        if (value >= starValue) {
            fillSvg.style.clipPath = 'inset(0 0% 0 0)';
        } else if (value > index) {
            const fraction = value - index;
            let visualPercentage;
            if (fraction <= 0.25) {
                visualPercentage = 30;
            } else if (fraction <= 0.5) {
                visualPercentage = 50;
            } else if (fraction <= 0.75) {
                visualPercentage = 70;
            } else {
                visualPercentage = 100;
            }
            fillSvg.style.clipPath = `inset(0 ${100 - visualPercentage}% 0 0)`;
        } else {
            fillSvg.style.clipPath = 'inset(0 100% 0 0)';
        }
    });
}

// Close modal on backdrop click
document.getElementById('detail-modal').addEventListener('click', function(e) {
    if (e.target === this) closeDetailModal();
});
</script>
{% endblock %}
